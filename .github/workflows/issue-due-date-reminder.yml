name: Issue due date reminders

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch: {}

permissions:
  issues: write

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - name: Remind on upcoming due dates
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0);

            const dueDateRegex = /due\s*date\s*[:ï¼š]\s*(\d{4}-\d{2}-\d{2})/i;
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: "open", per_page: 100 }
            );

            for (const issue of issues) {
              if (issue.pull_request) continue;
              const match = issue.body?.match(dueDateRegex);
              if (!match) continue;

              const dueDate = new Date(`${match[1]}T00:00:00Z`);
              const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
              if (![3, 1].includes(diffDays)) continue;

              const reminderTag = `Due date reminder (${match[1]})`;
              const comments = await github.paginate(
                github.rest.issues.listComments,
                { owner, repo, issue_number: issue.number, per_page: 100 }
              );
              const alreadyReminded = comments.some((comment) =>
                comment.body?.includes(reminderTag)
              );
              if (alreadyReminded) continue;

              const dayLabel = diffDays === 3 ? "3 days" : "1 day";
              const body = [
                `ðŸ”” ${reminderTag}`,
                ``,
                `This issue is due in ${dayLabel} on **${match[1]}**.`,
                `Please update the due date or status if needed.`,
              ].join("\n");

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body,
              });
            }
